# 第6章 屏蔽外部依赖的防火墙设计

## 1 服务雪崩

- 定义：由于一个服务失败而导致整条链路的服务都失败的情形
- 处理方式：设置超时时间，使用熔断设计模式

## 2 熔断设计模式

- 适用场景：在大型分布式系统中，调用或操作远程的服务或资源需要很长时间才能恢复，导致系统的部分失去响应，甚至导致整个系统完全不可用。
- 作用：防止应用程序不断地尝试可能会失败的操作，从而使得应用程序继续执行而不用等待修正错误，或浪费CPU时间去等待长时间的超时产生。
- 原理：适用状态机来实现，内部模拟如下状态：
    1. 闭合状态
    2. 断开状态：针对应用程序的请求会立即返回错误响应
    3. 半断开状态：允许针对应用程序发起的一定数量的请求去调用服务，如果调用成功，认为之前调用失败的错误已经修正
    
## 3 逻辑入侵

- 危害：
    1. 理解与维护成本升高：上下文之间的知识共享，知识理解困难，用于拆包解包的胶水代码的逻辑泛滥，导致维护困难
    2. 系统切换与升级困难：新旧系统的API依赖
    
## 4 防腐层设计

- 定义：新旧系统的业务模型的隔离与调用的隔离的系统边界
- 作用：用于隔离两个系统，允许两个系统相互之间在不了解对方领域知识的情况下进行集成
- 职责：
    1. 异常降级：对RPC可能出现的异常进行捕获
    2. 超时/重试：统一管理RPC接口的超时和重试
    3. 数据校验：对返回值进行校验
    4. 接口防腐：转成VO对象时，避免下游接口的修改导致自身系统的修改
    
## 5 设计思路

- 设计防火墙：用于屏蔽外部系统依赖带来的问题，进行不同层次的过滤
- 防火墙的层级：
    1. 对接层：定义对外部依赖的领域模型，关注点集中在提供的功能和需要的资源
    2. 适配层：用于对接层定义的领域模型与外部数据服务所需要的领域模型的适配
    3. 问题响应层：对依赖的外部服务进行统一保障
    4. 远程代理层：通过对远程服务调用接口的AOP，实现远程调用的本地化与无感知
    
## 6 后续优化

- 从实现角度看，在实现标准化的防腐层时，可以考虑PipeLine模式，构建远程处理通道，每一层对应通道中的一个Value